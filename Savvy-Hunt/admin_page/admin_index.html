<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Savvy Hunt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .dashboard-card {
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-8">

    <div class="max-w-5xl w-full">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-black text-gray-900 mb-4">üîê Savvy Hunt Admin</h1>
            <p class="text-gray-500">Select a module to manage</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- 1. Live Events -->
            <a href="events.html" class="dashboard-card bg-white p-8 rounded-2xl shadow-lg border-b-4 border-orange-500 flex flex-col items-center text-center cursor-pointer hover:border-orange-600 group">
                <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-3xl mb-6 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                    üì°
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Live Events</h2>
                <p class="text-gray-500 text-sm">Update current events, locations, and status.</p>
            </a>

            <!-- 2. Scoreboard -->
            <a href="scoreboard.html" class="dashboard-card bg-white p-8 rounded-2xl shadow-lg border-b-4 border-blue-500 flex flex-col items-center text-center cursor-pointer hover:border-blue-600 group">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mb-6 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    üèÜ
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Scoreboard</h2>
                <p class="text-gray-500 text-sm">Manage team points and calculate totals.</p>
            </a>

            <!-- 3. Gallery -->
            <a href="snapshots.html" class="dashboard-card bg-white p-8 rounded-2xl shadow-lg border-b-4 border-purple-500 flex flex-col items-center text-center cursor-pointer hover:border-purple-600 group">
                <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-3xl mb-6 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                    üì∏
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Gallery Uploads</h2>
                <p class="text-gray-500 text-sm">Upload photos and videos for the public feed.</p>
            </a>

        </div>

        <div class="text-center mt-12">
            <a href="../index.html" class="text-gray-400 hover:text-gray-600 text-sm underline">Back to Public Website</a>
        </div>
    </div>


  

  <script>
    // --- 1. SUPABASE CONFIGURATION (existing) ---
    const SUPABASE_URL = 'https://updkjbvelzlleowheeyq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwZGtqYnZlbHpsbGVvd2hlZXlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTI2NzcsImV4cCI6MjA3ODk2ODY3N30.lmCwbNDt3CiRXCVWjJl-4ZB242Ttfoo-J9yw3W7_Ark';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const SNAPSHOTS_BUCKET = 'snapshots';

    // --- 2. EXISTING APP LOGIC (events UI) ---
    const form = document.getElementById('add-event-form');
    const listContainer = document.getElementById('admin-events-list');
    fetchEvents();
    db
      .channel('admin-channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'live_events' }, (payload) => {
        fetchEvents();
      })
      .subscribe();

    async function fetchEvents() {
      const { data, error } = await db
        .from('live_events')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) {
        listContainer.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        return;
      }
      renderList(data);
    }

    function renderList(events) {
      listContainer.innerHTML = '';
      if (!events || events.length === 0) {
        listContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No events in database. Add one above!</p>';
        return;
      }
      events.forEach(event => {
        const item = document.createElement('div');
        item.className = "bg-gray-50 p-4 rounded-lg border border-gray-200 hover:border-orange-200 transition flex justify-between items-center group mb-2";
        item.style.backgroundColor = "#f9fafb";
        let statusColor = event.status === 'Live' ? 'bg-red-100 text-red-700 border-red-200' : (event.status === 'Soon' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-gray-200 text-gray-700 border-gray-300');
        item.innerHTML = `
          <div class="flex items-center gap-4">
            <div class="${statusColor} border px-3 py-1 rounded text-xs font-bold w-20 text-center"> ${event.status} </div>
            <div>
              <h3 class="font-bold text-gray-900 text-lg">${event.name}</h3>
              <p class="text-xs text-gray-500 flex gap-3 items-center">
                <span>üìç ${event.location}</span>
                <span class="text-gray-300">|</span>
                <span>üë• ${event.teams} Teams</span>
                <span class="text-gray-300">|</span>
                <span class="font-semibold text-orange-600">üè∑Ô∏è ${event.category || 'General'}</span>
              </p>
            </div>
          </div>
          <button onclick="deleteEvent('${event.id}')" class="text-gray-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition" title="Delete Event"> ‚ùå </button>
        `;
        listContainer.appendChild(item);
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = form.querySelector('button');
      submitBtn.innerHTML = 'Saving...';
      submitBtn.disabled = true;
      const newEvent = {
        name: document.getElementById('event-name').value,
        location: document.getElementById('event-location').value,
        teams: document.getElementById('team-count').value,
        status: document.getElementById('event-status').value,
        category: document.getElementById('event-category').value
      };
      const { error } = await db.from('live_events').insert([newEvent]);
      submitBtn.innerHTML = 'Publish Event';
      submitBtn.disabled = false;
      if (error) showToast('Error: ' + error.message, 'bg-red-600');
      else {
        showToast('Event published successfully!');
        form.reset();
      }
    });

    window.deleteEvent = async (id) => {
      if (confirm('Are you sure you want to delete this event?')) {
        const { error } = await db.from('live_events').delete().eq('id', id);
        if (error) showToast('Error deleting: ' + error.message, 'bg-red-600');
        else showToast('Event deleted!');
      }
    }

    //  Admin Snapshots Upload Logic (uses existing `supabase`) ////
    const dropzone = document.getElementById('dropzone');
    const snapFiles = document.getElementById('snapFiles');
    const uploadStartBtn = document.getElementById('uploadStartBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const globalProgress = document.getElementById('globalProgress');
    const progressText = document.getElementById('progressText');
    const progressCount = document.getElementById('progressCount');
    const refreshGalleryBtn = document.getElementById('refreshGalleryBtn');
    const adminGallery = document.getElementById('adminGallery');
    const toast = document.getElementById('toast');

    // Drag & drop UI
    ['dragenter','dragover'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });
    ['dragleave','drop','dragend'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files && files.length) {
        snapFiles.files = files;
        progressText.innerText = `${files.length} file(s) selected`;
      }
    });

    // Clicking the visible link opens file browser
    document.querySelector('label[for="snapFiles"]').addEventListener('click', (e) => {
      e.preventDefault(); // prevent default for label
      snapFiles.click();
    });
    
    // Fallback for clicking the dropzone area but not the label/input
    dropzone.addEventListener('click', (e) => {
        // Only open file dialog if the click is not on the input or label itself (which already handle it)
        if (e.target.id === 'dropzone') { 
            snapFiles.click();
        }
    });


    snapFiles.addEventListener('change', () => {
      const count = snapFiles.files.length;
      progressText.innerText = `${count} file(s) selected`;
    });

    clearSelectionBtn.addEventListener('click', () => {
      snapFiles.value = '';
      globalProgress.style.width = '0%';
      progressText.innerText = 'Selection cleared';
      progressCount.innerText = '';
    });

    refreshGalleryBtn.addEventListener('click', () => loadAdminGallery());

    async function uploadSnapshots() {
      const files = snapFiles.files;
      if (!files || files.length === 0) return showToast('Select files first.', 'bg-yellow-600');

      uploadStartBtn.disabled = true;
      clearSelectionBtn.disabled = true;
      progressText.innerText = 'Uploading...';
      const total = files.length;
      let uploadSuccessCount = 0;

      for (let i = 0; i < total; i++) {
        const file = files[i];
        // Create a unique filename to prevent conflicts
        const filePath = `${Date.now()}-${file.name.replace(/ /g, '_')}`;

        progressCount.innerText = `${i+1}/${total}`;
        globalProgress.style.width = `${Math.round(((i) / total) * 100)}%`;

        try {
          const { error } = await db.storage.from(SNAPSHOTS_BUCKET).upload(filePath, file, { upsert: false });
          if (error) throw error;
          uploadSuccessCount++;
        } catch (err) {
          console.error('Upload error for file', file.name, err);
          showToast(`Upload failed for ${file.name}.`, 'bg-red-600');
        }

        globalProgress.style.width = `${Math.round(((i+1) / total) * 100)}%`;
      }

      // Done
      if (uploadSuccessCount > 0) {
        progressText.innerText = `Finished: ${uploadSuccessCount} files uploaded successfully.`;
        showToast('Upload successful ‚Äî files available to public gallery');
        loadAdminGallery();
      } else {
        progressText.innerText = 'No files were uploaded.';
        showToast('No files uploaded.', 'bg-yellow-600');
      }

      snapFiles.value = '';
      uploadStartBtn.disabled = false;
      clearSelectionBtn.disabled = false;
      setTimeout(() => { globalProgress.style.width = '0%'; progressCount.innerText = ''; }, 3000);
    }

    uploadStartBtn.addEventListener('click', uploadSnapshots);

    // Small toast helper
    function showToast(msg = 'Saved', colorClass = 'bg-gray-900') {
      toast.innerText = msg;
      toast.className = `toast ${colorClass}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // Load admin preview gallery
    async function loadAdminGallery() {
      adminGallery.innerHTML = '<p class="text-gray-400 col-span-full italic">Loading...</p>';

      const { data, error } = await db.storage.from(SNAPSHOTS_BUCKET).list('', { limit: 200, sortBy: { column: 'created_at', order: 'desc' } });
      
      if (error) {
        adminGallery.innerHTML = `<p class="text-red-500 col-span-full">Error loading gallery: ${error.message}</p>`;
        return;
      }

      adminGallery.innerHTML = '';
      if (data.length === 0 || data.every(file => file.id === null)) { // Check if only directories or empty
        const empty = document.createElement('div');
        empty.className = 'text-gray-500 col-span-full';
        empty.innerText = 'No uploads yet';
        adminGallery.appendChild(empty);
        return;
      }

      for (const file of data) {
        // Skip directories which are also returned in the list
        if (file.id === null) continue;
        
        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${SNAPSHOTS_BUCKET}/${encodeURIComponent(file.name)}`;
        const ext = (file.name.split('.').pop() || '').toLowerCase();

        const card = document.createElement('div');
        card.className = 'thumb';
        
        let mediaHTML;

        if (['mp4','mov','webm','ogg'].includes(ext)) {
          mediaHTML = `<video src="${publicUrl}" controls class="w-full h-40 object-cover rounded"></video>`;
        } else {
          mediaHTML = `<img src="${publicUrl}" alt="${file.name}" class="w-full h-40 object-cover rounded" />`;
        }

        // Add delete button
        card.innerHTML = mediaHTML + `<button onclick="deleteSnapshot('${file.name}')" title="Delete Snapshot">‚úï</button>`;
        
        adminGallery.appendChild(card);
      }
    }
    
    window.deleteSnapshot = async (fileName) => {
        if (!confirm(`Are you sure you want to delete the file: ${fileName}?`)) return;

        const { error } = await db.storage.from(SNAPSHOTS_BUCKET).remove([fileName]);

        if (error) {
            showToast(`Error deleting file: ${error.message}`, 'bg-red-600');
        } else {
            showToast('Snapshot deleted successfully.');
            loadAdminGallery();
        }
    }
    //---------------------------------------------
    //  SCOREBOARD ADMIN MANAGEMENT
    //---------------------------------------------

    async function loadScoreboardAdmin() {
      const box = document.getElementById('scoreboard-admin');
      box.innerHTML = '<p class="text-gray-400 italic">Loading...</p>';

      const { data, error } = await db
          .from('scoreboard')
          .select('*')
          .order('total', { ascending: false });

      if (error) {
        box.innerHTML = `<p class="text-red-500">Error loading scoreboard: ${error.message}</p>`;
        return;
      }

      renderScoreboardAdmin(data);
    }

    function renderScoreboardAdmin(rows) {
      const box = document.getElementById('scoreboard-admin');

      let html = `
        <table class="min-w-full text-sm text-left border">
          <thead class="bg-gray-100 font-bold">
            <tr>
              <th class="p-2 border">Rank</th>
              <th class="p-2 border">Institution</th>
              <th class="p-2 border">Cat 1</th>
              <th class="p-2 border">Cat 2</th>
              <th class="p-2 border">Cat 3</th>
              <th class="p-2 border">Cat 4</th>
              <th class="p-2 border">Cat 5</th>
              <th class="p-2 border">Total</th>
              <th class="p-2 border">Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      rows.forEach((row, index) => {
        html += `
          <tr class="border">
            <td class="p-2 border">${index + 1}</td>
            <td class="p-2 border">${row.name}</td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat1}" onchange="updateScore(${row.id}, 'cat1', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat2}" onchange="updateScore(${row.id}, 'cat2', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat3}" onchange="updateScore(${row.id}, 'cat3', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat4}" onchange="updateScore(${row.id}, 'cat4', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat5}" onchange="updateScore(${row.id}, 'cat5', this.value)"></td>
            <td class="p-2 border font-bold">${row.total}</td>
            <td class="p-2 border">
              <button onclick="recalculate(${row.id})"
                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-xs">
                Recalc
              </button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;

      box.innerHTML = html;
    }

    // Update individual category
    async function updateScore(id, field, value) {
      value = Number(value);
      const { error } = await db
          .from('scoreboard')
          .update({ [field]: value })
          .eq('id', id);

      if (error) {
        showToast("Update failed: " + error.message, 'bg-red-600');
      } else {
        showToast("Score updated!");
        recalcTotal(id);
      }
    }

    // Recalculate total
    async function recalcTotal(id) {
      const { data } = await db
          .from('scoreboard')
          .select('cat1, cat2, cat3, cat4, cat5')
          .eq('id', id)
          .single();

      const total =
        Number(data.cat1) +
        Number(data.cat2) +
        Number(data.cat3) +
        Number(data.cat4) +
        Number(data.cat5);

      await db  
          .from('scoreboard')
          .update({ total })
          .eq('id', id);

      loadScoreboardAdmin();
    }

    // Initial load
    loadScoreboardAdmin();


    // initial gallery load
    loadAdminGallery();

  </script>
</body>
</html>