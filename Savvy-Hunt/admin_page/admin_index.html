<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Savvy Hunt - Admin Control</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Safety Styles + small custom tweaks */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6 !important; color: #111827 !important; }
    .safety-container { background-color: white; color: black; }
    /* Snapshots upload styles */
    .dropzone {
      border: 2px dashed #ff7a00;
      background: linear-gradient(180deg, #fffaf2 0%, #fff3e6 100%);
      padding: 28px;
      border-radius: 12px;
      text-align: center;
      transition: box-shadow .18s, transform .12s;
    }
    .dropzone.dragover {
      box-shadow: 0 10px 30px rgba(255,122,0,0.14);
      transform: translateY(-4px);
    }
    .progress-track { background: #ffe8d6; height: 10px; border-radius: 999px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg,#ff7a00,#ffb36b); transition: width .2s ease; }
    .toast {
      position: fixed;
      right: 20px;
      bottom: 30px;
      background: #111827;
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      display: none;
      z-index: 1000;
    }
    .thumb {
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #ffecd6;
      background: white;
      position: relative; /* Needed for delete button */
    }
    .thumb button {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.6);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        font-size: 14px;
        line-height: 1;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .thumb button:hover { opacity: 1; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto">

    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-black text-gray-900 flex items-center"> üîê Admin Dashboard </h1>
      <a href="#" onclick="alert('This would link to your public website')" class="bg-white border border-gray-300 px-4 py-2 rounded hover:bg-gray-50 text-sm font-bold text-gray-700"> Open Public Website &rarr; </a>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-orange-500 safety-container">
      <h2 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">Add New Event</h2>
      <form id="add-event-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1">Event Name</label>
          <input type="text" id="event-name" placeholder="e.g. Riddle Relay" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-orange-500 outline-none" required>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-1">Location</label>
          <input type="text" id="event-location" placeholder="e.g. Main Quad" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-orange-500 outline-none" required>
        </div>

        <div class="flex gap-4">
          <div class="w-1/2">
            <label class="block text-sm font-bold text-gray-700 mb-1">Team Count</label>
            <input type="number" id="team-count" placeholder="e.g. 8" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-orange-500 outline-none" required>
          </div>
          <div class="w-1/2">
            <label class="block text-sm font-bold text-gray-700 mb-1">Status</label>
            <select id="event-status" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-orange-500 outline-none" required>
              <option value="Live">Live üî¥</option>
              <option value="Soon">Soon üü°</option>
              <option value="Finished">Finished ‚ö´</option>
            </select>
          </div>
        </div>

        <div class="flex gap-4 items-end">
          <div class="w-full">
            <label class="block text-sm font-bold text-gray-700 mb-1">Category</label>
            <input type="text" id="event-category" placeholder="e.g. Puzzle, Physical, Art" class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-orange-500 outline-none" required>
          </div>
          <button type="submit" class="w-full bg-orange-500 text-white font-bold px-6 py-3 rounded hover:bg-orange-600 transition shadow-md h-[50px]" style="background-color: #f97316;"> Publish Event </button>
        </div>
      </form>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 safety-container mb-8">
      <div class="flex justify-between items-center mb-6 border-b pb-2">
        <h2 class="text-xl font-bold text-gray-800">Live Database View</h2>
        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full flex items-center">
          <span class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span> Connected
        </span>
      </div>
      <div id="admin-events-list" class="space-y-3">
        <p class="text-gray-500 italic">Connecting to Supabase...</p>
      </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-lg safety-container mb-12 border-t-4 border-orange-500">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-bold text-gray-800">Admin ‚Äî Upload Snapshots</h2>
          <p class="text-sm text-gray-500">Upload images & videos that will be visible on the public Snapshots page. Files are saved to the <span class="font-mono">snapshots</span> bucket.</p>
        </div>
        <div>
          <button id="refreshGalleryBtn" class="bg-white border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 text-sm font-semibold">Refresh Gallery</button>
        </div>
      </div>

      <div id="dropzone" class="dropzone mb-4">
        <p class="text-lg font-semibold text-orange-700">Drag & Drop files here or <label for="snapFiles" class="underline cursor-pointer text-orange-700">browse</label></p>
        <p class="text-sm text-gray-600 mt-1">Images & videos accepted (jpg, png, mp4, webm, mov). Max file size depends on your Supabase plan.</p>
        <input id="snapFiles" type="file" accept="image/*,video/*" multiple class="hidden">
      </div>

      <div class="mb-4">
        <div class="progress-track w-full rounded-full overflow-hidden">
          <div id="globalProgress" class="progress-fill"></div>
        </div>
        <div class="flex justify-between mt-2 text-sm">
          <div id="progressText" class="text-gray-600">No uploads yet</div>
          <div id="progressCount" class="text-gray-500"></div>
        </div>
      </div>

      <div class="flex gap-3">
        <button id="uploadStartBtn" class="bg-orange-500 text-white px-4 py-2 rounded font-semibold hover:bg-orange-600">Start Upload</button>
        <button id="clearSelectionBtn" class="bg-white border border-gray-300 px-4 py-2 rounded hover:bg-gray-50">Clear</button>
      </div>

      <h3 class="mt-6 mb-3 text-gray-700 font-semibold">Admin Preview Gallery</h3>
      <div id="adminGallery" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <p class="text-gray-400 italic col-span-4">Loading Admin Gallery...</p>
      </div>
    </div>
    </div>

      <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-blue-500">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Scoreboard Manager</h2>
      <p class="text-sm text-gray-500 mb-4">View and update institution points for each category.</p>

      <div id="scoreboard-admin" class="overflow-x-auto">
        <p class="text-gray-400 italic">Loading scoreboard...</p>
      </div>
    </div>


  <div id="toast" class="toast">Uploaded successfully</div>

  <script>
    // --- 1. SUPABASE CONFIGURATION (existing) ---
    const SUPABASE_URL = 'https://updkjbvelzlleowheeyq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwZGtqYnZlbHpsbGVvd2hlZXlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTI2NzcsImV4cCI6MjA3ODk2ODY3N30.lmCwbNDt3CiRXCVWjJl-4ZB242Ttfoo-J9yw3W7_Ark';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const SNAPSHOTS_BUCKET = 'snapshots';

    // --- 2. EXISTING APP LOGIC (events UI) ---
    const form = document.getElementById('add-event-form');
    const listContainer = document.getElementById('admin-events-list');
    fetchEvents();
    db
      .channel('admin-channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'live_events' }, (payload) => {
        fetchEvents();
      })
      .subscribe();

    async function fetchEvents() {
      const { data, error } = await db
        .from('live_events')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) {
        listContainer.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        return;
      }
      renderList(data);
    }

    function renderList(events) {
      listContainer.innerHTML = '';
      if (!events || events.length === 0) {
        listContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No events in database. Add one above!</p>';
        return;
      }
      events.forEach(event => {
        const item = document.createElement('div');
        item.className = "bg-gray-50 p-4 rounded-lg border border-gray-200 hover:border-orange-200 transition flex justify-between items-center group mb-2";
        item.style.backgroundColor = "#f9fafb";
        let statusColor = event.status === 'Live' ? 'bg-red-100 text-red-700 border-red-200' : (event.status === 'Soon' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-gray-200 text-gray-700 border-gray-300');
        item.innerHTML = `
          <div class="flex items-center gap-4">
            <div class="${statusColor} border px-3 py-1 rounded text-xs font-bold w-20 text-center"> ${event.status} </div>
            <div>
              <h3 class="font-bold text-gray-900 text-lg">${event.name}</h3>
              <p class="text-xs text-gray-500 flex gap-3 items-center">
                <span>üìç ${event.location}</span>
                <span class="text-gray-300">|</span>
                <span>üë• ${event.teams} Teams</span>
                <span class="text-gray-300">|</span>
                <span class="font-semibold text-orange-600">üè∑Ô∏è ${event.category || 'General'}</span>
              </p>
            </div>
          </div>
          <button onclick="deleteEvent('${event.id}')" class="text-gray-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition" title="Delete Event"> ‚ùå </button>
        `;
        listContainer.appendChild(item);
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = form.querySelector('button');
      submitBtn.innerHTML = 'Saving...';
      submitBtn.disabled = true;
      const newEvent = {
        name: document.getElementById('event-name').value,
        location: document.getElementById('event-location').value,
        teams: document.getElementById('team-count').value,
        status: document.getElementById('event-status').value,
        category: document.getElementById('event-category').value
      };
      const { error } = await db.from('live_events').insert([newEvent]);
      submitBtn.innerHTML = 'Publish Event';
      submitBtn.disabled = false;
      if (error) showToast('Error: ' + error.message, 'bg-red-600');
      else {
        showToast('Event published successfully!');
        form.reset();
      }
    });

    window.deleteEvent = async (id) => {
      if (confirm('Are you sure you want to delete this event?')) {
        const { error } = await db.from('live_events').delete().eq('id', id);
        if (error) showToast('Error deleting: ' + error.message, 'bg-red-600');
        else showToast('Event deleted!');
      }
    }

    //  Admin Snapshots Upload Logic (uses existing `supabase`) ////
    const dropzone = document.getElementById('dropzone');
    const snapFiles = document.getElementById('snapFiles');
    const uploadStartBtn = document.getElementById('uploadStartBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const globalProgress = document.getElementById('globalProgress');
    const progressText = document.getElementById('progressText');
    const progressCount = document.getElementById('progressCount');
    const refreshGalleryBtn = document.getElementById('refreshGalleryBtn');
    const adminGallery = document.getElementById('adminGallery');
    const toast = document.getElementById('toast');

    // Drag & drop UI
    ['dragenter','dragover'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });
    ['dragleave','drop','dragend'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files && files.length) {
        snapFiles.files = files;
        progressText.innerText = `${files.length} file(s) selected`;
      }
    });

    // Clicking the visible link opens file browser
    document.querySelector('label[for="snapFiles"]').addEventListener('click', (e) => {
      e.preventDefault(); // prevent default for label
      snapFiles.click();
    });
    
    // Fallback for clicking the dropzone area but not the label/input
    dropzone.addEventListener('click', (e) => {
        // Only open file dialog if the click is not on the input or label itself (which already handle it)
        if (e.target.id === 'dropzone') { 
            snapFiles.click();
        }
    });


    snapFiles.addEventListener('change', () => {
      const count = snapFiles.files.length;
      progressText.innerText = `${count} file(s) selected`;
    });

    clearSelectionBtn.addEventListener('click', () => {
      snapFiles.value = '';
      globalProgress.style.width = '0%';
      progressText.innerText = 'Selection cleared';
      progressCount.innerText = '';
    });

    refreshGalleryBtn.addEventListener('click', () => loadAdminGallery());

    async function uploadSnapshots() {
      const files = snapFiles.files;
      if (!files || files.length === 0) return showToast('Select files first.', 'bg-yellow-600');

      uploadStartBtn.disabled = true;
      clearSelectionBtn.disabled = true;
      progressText.innerText = 'Uploading...';
      const total = files.length;
      let uploadSuccessCount = 0;

      for (let i = 0; i < total; i++) {
        const file = files[i];
        // Create a unique filename to prevent conflicts
        const filePath = `${Date.now()}-${file.name.replace(/ /g, '_')}`;

        progressCount.innerText = `${i+1}/${total}`;
        globalProgress.style.width = `${Math.round(((i) / total) * 100)}%`;

        try {
          const { error } = await db.storage.from(SNAPSHOTS_BUCKET).upload(filePath, file, { upsert: false });
          if (error) throw error;
          uploadSuccessCount++;
        } catch (err) {
          console.error('Upload error for file', file.name, err);
          showToast(`Upload failed for ${file.name}.`, 'bg-red-600');
        }

        globalProgress.style.width = `${Math.round(((i+1) / total) * 100)}%`;
      }

      // Done
      if (uploadSuccessCount > 0) {
        progressText.innerText = `Finished: ${uploadSuccessCount} files uploaded successfully.`;
        showToast('Upload successful ‚Äî files available to public gallery');
        loadAdminGallery();
      } else {
        progressText.innerText = 'No files were uploaded.';
        showToast('No files uploaded.', 'bg-yellow-600');
      }

      snapFiles.value = '';
      uploadStartBtn.disabled = false;
      clearSelectionBtn.disabled = false;
      setTimeout(() => { globalProgress.style.width = '0%'; progressCount.innerText = ''; }, 3000);
    }

    uploadStartBtn.addEventListener('click', uploadSnapshots);

    // Small toast helper
    function showToast(msg = 'Saved', colorClass = 'bg-gray-900') {
      toast.innerText = msg;
      toast.className = `toast ${colorClass}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // Load admin preview gallery
    async function loadAdminGallery() {
      adminGallery.innerHTML = '<p class="text-gray-400 col-span-full italic">Loading...</p>';

      const { data, error } = await db.storage.from(SNAPSHOTS_BUCKET).list('', { limit: 200, sortBy: { column: 'created_at', order: 'desc' } });
      
      if (error) {
        adminGallery.innerHTML = `<p class="text-red-500 col-span-full">Error loading gallery: ${error.message}</p>`;
        return;
      }

      adminGallery.innerHTML = '';
      if (data.length === 0 || data.every(file => file.id === null)) { // Check if only directories or empty
        const empty = document.createElement('div');
        empty.className = 'text-gray-500 col-span-full';
        empty.innerText = 'No uploads yet';
        adminGallery.appendChild(empty);
        return;
      }

      for (const file of data) {
        // Skip directories which are also returned in the list
        if (file.id === null) continue;
        
        const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${SNAPSHOTS_BUCKET}/${encodeURIComponent(file.name)}`;
        const ext = (file.name.split('.').pop() || '').toLowerCase();

        const card = document.createElement('div');
        card.className = 'thumb';
        
        let mediaHTML;

        if (['mp4','mov','webm','ogg'].includes(ext)) {
          mediaHTML = `<video src="${publicUrl}" controls class="w-full h-40 object-cover rounded"></video>`;
        } else {
          mediaHTML = `<img src="${publicUrl}" alt="${file.name}" class="w-full h-40 object-cover rounded" />`;
        }

        // Add delete button
        card.innerHTML = mediaHTML + `<button onclick="deleteSnapshot('${file.name}')" title="Delete Snapshot">‚úï</button>`;
        
        adminGallery.appendChild(card);
      }
    }
    
    window.deleteSnapshot = async (fileName) => {
        if (!confirm(`Are you sure you want to delete the file: ${fileName}?`)) return;

        const { error } = await db.storage.from(SNAPSHOTS_BUCKET).remove([fileName]);

        if (error) {
            showToast(`Error deleting file: ${error.message}`, 'bg-red-600');
        } else {
            showToast('Snapshot deleted successfully.');
            loadAdminGallery();
        }
    }
    //---------------------------------------------
    //  SCOREBOARD ADMIN MANAGEMENT
    //---------------------------------------------

    async function loadScoreboardAdmin() {
      const box = document.getElementById('scoreboard-admin');
      box.innerHTML = '<p class="text-gray-400 italic">Loading...</p>';

      const { data, error } = await db
          .from('scoreboard')
          .select('*')
          .order('total', { ascending: false });

      if (error) {
        box.innerHTML = `<p class="text-red-500">Error loading scoreboard: ${error.message}</p>`;
        return;
      }

      renderScoreboardAdmin(data);
    }

    function renderScoreboardAdmin(rows) {
      const box = document.getElementById('scoreboard-admin');

      let html = `
        <table class="min-w-full text-sm text-left border">
          <thead class="bg-gray-100 font-bold">
            <tr>
              <th class="p-2 border">Rank</th>
              <th class="p-2 border">Institution</th>
              <th class="p-2 border">Cat 1</th>
              <th class="p-2 border">Cat 2</th>
              <th class="p-2 border">Cat 3</th>
              <th class="p-2 border">Cat 4</th>
              <th class="p-2 border">Cat 5</th>
              <th class="p-2 border">Total</th>
              <th class="p-2 border">Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      rows.forEach((row, index) => {
        html += `
          <tr class="border">
            <td class="p-2 border">${index + 1}</td>
            <td class="p-2 border">${row.name}</td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat1}" onchange="updateScore(${row.id}, 'cat1', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat2}" onchange="updateScore(${row.id}, 'cat2', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat3}" onchange="updateScore(${row.id}, 'cat3', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat4}" onchange="updateScore(${row.id}, 'cat4', this.value)"></td>
            <td class="p-2 border"><input class="w-16 p-1 border rounded" value="${row.cat5}" onchange="updateScore(${row.id}, 'cat5', this.value)"></td>
            <td class="p-2 border font-bold">${row.total}</td>
            <td class="p-2 border">
              <button onclick="recalculate(${row.id})"
                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-xs">
                Recalc
              </button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;

      box.innerHTML = html;
    }

    // Update individual category
    async function updateScore(id, field, value) {
      value = Number(value);
      const { error } = await db
          .from('scoreboard')
          .update({ [field]: value })
          .eq('id', id);

      if (error) {
        showToast("Update failed: " + error.message, 'bg-red-600');
      } else {
        showToast("Score updated!");
        recalcTotal(id);
      }
    }

    // Recalculate total
    async function recalcTotal(id) {
      const { data } = await db
          .from('scoreboard')
          .select('cat1, cat2, cat3, cat4, cat5')
          .eq('id', id)
          .single();

      const total =
        Number(data.cat1) +
        Number(data.cat2) +
        Number(data.cat3) +
        Number(data.cat4) +
        Number(data.cat5);

      await db  
          .from('scoreboard')
          .update({ total })
          .eq('id', id);

      loadScoreboardAdmin();
    }

    // Initial load
    loadScoreboardAdmin();


    // initial gallery load
    loadAdminGallery();

  </script>
</body>
</html>